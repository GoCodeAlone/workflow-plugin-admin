# Built-in Workflow Admin UI Configuration
#
# This config is embedded into the binary and enabled with the --admin flag.
# It dogfoods the workflow engine to serve its own admin UI: the engine's
# modules (HTTP server, router, auth, static file server, management API)
# provide an authenticated admin interface running on the same engine as the
# primary workflow.
#
# Usage:
#   JWT_SECRET=your-secret go run ./cmd/server \
#     -config your-workflow.yaml --admin
#
# On first launch, visit the admin UI to create your admin account.
#
# Decomposition notes (see docs/ADMIN_CONFIG_DECOMPOSITION.md):
# - Phase A: 16 domain-specific query/command modules consolidated into 2 generic handlers
# - Phase B: V1 CRUD routes decomposed into pipeline primitives (db_query/db_exec)
# - Phase C: Missing DB tables added, broken routes replaced with working pipelines
# - Phase D: All remaining delegate steps given meaningful names
# - Phase D+: Pre-processing pipeline steps (validation, pagination, rate limiting) for domain routes

modules:
  # --- HTTP Server (admin port) ---
  - name: admin-server
    type: http.server
    config:
      address: ":8081"

  - name: admin-router
    type: http.router
    dependsOn: [admin-server]

  # --- Middleware ---
  - name: admin-cors
    type: http.middleware.cors
    config:
      allowedOrigins: ["*"]
      allowedMethods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]

  - name: admin-ratelimit
    type: http.middleware.ratelimit
    config:
      requestsPerMinute: 120
      burstSize: 20

  # Strict per-IP rate limiter for login: 10 attempts/minute, burst 10
  - name: auth-login-ratelimit
    type: http.middleware.ratelimit
    config:
      requestsPerMinute: 10
      burstSize: 10

  # Strict per-IP rate limiter for registration: 5 attempts/hour, burst 5
  - name: auth-register-ratelimit
    type: http.middleware.ratelimit
    config:
      requestsPerHour: 5
      burstSize: 5

  # --- Data Layer ---
  - name: admin-db
    type: storage.sqlite
    config:
      dbPath: "data/workflow.db"

  - name: admin-workflow-registry
    type: workflow.registry
    config:
      storageBackend: "admin-db"
    dependsOn: [admin-db]

  - name: admin-user-store
    type: auth.user-store
    dependsOn: [admin-db]

  # --- Auth ---
  - name: admin-auth
    type: auth.jwt
    config:
      secret: "${JWT_SECRET}"
      tokenExpiry: "24h"
      issuer: "workflow-admin"
      responseFormat: "v1"
    dependsOn: [admin-user-store]

  - name: admin-auth-middleware
    type: http.middleware.auth
    config:
      authType: Bearer
    dependsOn: [admin-auth]

  # --- Generic CQRS Handlers (Phase A: consolidated from 18 domain-specific modules) ---
  - name: admin-queries
    type: api.query
    dependsOn: [admin-router]

  - name: admin-commands
    type: api.command
    dependsOn: [admin-router]

  # --- Static File Server (serves admin React UI built separately) ---
  # Set root to the directory containing the built admin UI assets.
  # Override at runtime via --admin-ui-dir flag or ADMIN_UI_DIR env var.
  - name: admin-ui
    type: static.fileserver
    config:
      root: "./ui/dist"
      prefix: "/"
      spaFallback: true
      cacheMaxAge: 3600
      router: admin-router
    dependsOn: [admin-router]

  # --- OpenAPI ---
  - name: admin-openapi
    type: openapi.generator
    config:
      title: "Workflow Admin API"
      version: "1.0.0"
      description: "Auto-generated OpenAPI spec from the workflow admin routes"
    dependsOn: [admin-router]

  # --- Observability ---
  - name: admin-health
    type: health.checker

  - name: admin-metrics
    type: metrics.collector

  # --- Feature Flags ---
  # Provides the feature-flag admin service; auto-discovered by the V1 API handler.
  - name: admin-feature-flags
    type: featureflag.service
    config:
      provider: "generic"
      cache_ttl: "30s"
      sse_enabled: true
      db_path: "data/featureflags.db"

  # --- Event Store ---
  # Provides the execution event store; auto-discovered by timeline and replay modules.
  - name: admin-event-store
    type: eventstore.service
    config:
      db_path: "data/events.db"
      retention_days: 90

  # --- Timeline / Replay ---
  # Provides timeline, replay, and backfill/mock/diff HTTP handlers.
  - name: admin-timeline
    type: timeline.service
    config:
      event_store: "admin-event-store"

  # --- Dead Letter Queue ---
  # Provides DLQ management HTTP endpoints.
  - name: admin-dlq
    type: dlq.service
    config:
      max_retries: 3
      retention_days: 30

workflows:
  http-admin:
    router: admin-router
    server: admin-server
    routes:
      # ============================================================
      # AUTH ROUTES (unauthenticated + authenticated)
      # These use the admin-auth handler directly — no changes needed
      # ============================================================

      # === Setup (unauthenticated) ===
      - method: GET
        path: "/api/v1/auth/setup-status"
        handler: admin-auth
        middlewares: [admin-cors, admin-ratelimit]
      - method: POST
        path: "/api/v1/auth/setup"
        handler: admin-auth
        middlewares: [admin-cors, admin-ratelimit]

      # === Auth (unauthenticated) ===
      # login: strict per-IP rate limit (10/minute) to defend against brute-force
      - method: POST
        path: "/api/v1/auth/login"
        handler: admin-auth
        middlewares: [admin-cors, auth-login-ratelimit]
      # register: strict per-IP rate limit (5/hour) to defend against account enumeration
      - method: POST
        path: "/api/v1/auth/register"
        handler: admin-auth
        middlewares: [admin-cors, auth-register-ratelimit]
      - method: POST
        path: "/api/v1/auth/refresh"
        handler: admin-auth
        middlewares: [admin-cors]

      # === Auth (authenticated) ===
      - method: POST
        path: "/api/v1/auth/logout"
        handler: admin-auth
        middlewares: [admin-cors, admin-auth-middleware]
      - method: GET
        path: "/api/v1/auth/me"
        handler: admin-auth
        middlewares: [admin-cors, admin-auth-middleware]
      - method: PUT
        path: "/api/v1/auth/me"
        handler: admin-auth
        middlewares: [admin-cors, admin-auth-middleware]

      # === User Management (authenticated, admin-only) ===
      - method: GET
        path: "/api/v1/auth/users"
        handler: admin-auth
        middlewares: [admin-cors, admin-auth-middleware]
      - method: POST
        path: "/api/v1/auth/users"
        handler: admin-auth
        middlewares: [admin-cors, admin-auth-middleware]
      - method: DELETE
        path: "/api/v1/auth/users/{id}"
        handler: admin-auth
        middlewares: [admin-cors, admin-auth-middleware]
      - method: PUT
        path: "/api/v1/auth/users/{id}/role"
        handler: admin-auth
        middlewares: [admin-cors, admin-auth-middleware]

      # ============================================================
      # ENGINE MANAGEMENT (Phase D: delegates with meaningful names)
      # These require Go service logic — kept as delegates
      # ============================================================

      - method: GET
        path: "/api/v1/admin/engine/config"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: get-engine-config
              type: step.delegate
              config:
                service: admin-engine-mgmt
      - method: GET
        path: "/api/v1/admin/engine/status"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: get-engine-status
              type: step.delegate
              config:
                service: admin-engine-mgmt
      - method: GET
        path: "/api/v1/admin/engine/modules"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-engine-modules
              type: step.delegate
              config:
                service: admin-engine-mgmt
      - method: GET
        path: "/api/v1/admin/engine/services"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-engine-services
              type: step.delegate
              config:
                service: admin-engine-mgmt

      - method: PUT
        path: "/api/v1/admin/engine/config"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: update-engine-config
              type: step.delegate
              config:
                service: admin-engine-mgmt
      - method: POST
        path: "/api/v1/admin/engine/validate"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: validate-body
              type: step.validate_request_body
              config:
                required_fields: [config]
            - name: validate-engine-config
              type: step.delegate
              config:
                service: admin-engine-mgmt
      - method: POST
        path: "/api/v1/admin/engine/reload"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: rate-limit
              type: step.rate_limit
              config:
                requests_per_minute: 5
                burst_size: 2
                key_from: "global"
            - name: log-reload-attempt
              type: step.log
              config:
                level: warn
                message: "Engine reload requested via admin API"
            - name: reload-engine
              type: step.delegate
              config:
                service: admin-engine-mgmt

      # ============================================================
      # SCHEMA API (Phase D: delegates with meaningful names)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/schemas"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-schemas
              type: step.delegate
              config:
                service: admin-schema-mgmt
      - method: GET
        path: "/api/v1/admin/schemas/modules"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-module-schemas
              type: step.delegate
              config:
                service: admin-schema-mgmt

      # ============================================================
      # AI API (Phase D: delegates with meaningful names)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/ai/providers"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-ai-providers
              type: step.delegate
              config:
                service: admin-ai-mgmt
      - method: POST
        path: "/api/v1/admin/ai/generate"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: generate-workflow-from-intent
              type: step.delegate
              config:
                service: admin-ai-mgmt
      - method: POST
        path: "/api/v1/admin/ai/component"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: generate-component
              type: step.delegate
              config:
                service: admin-ai-mgmt
      - method: POST
        path: "/api/v1/admin/ai/suggest"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: suggest-improvements
              type: step.delegate
              config:
                service: admin-ai-mgmt
      - method: POST
        path: "/api/v1/admin/ai/deploy"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: deploy-generated-workflow
              type: step.delegate
              config:
                service: admin-ai-mgmt
      - method: POST
        path: "/api/v1/admin/ai/deploy/component"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: deploy-generated-component
              type: step.delegate
              config:
                service: admin-ai-mgmt

      # ============================================================
      # DYNAMIC COMPONENTS (Phase D: delegates with meaningful names)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/components"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-dynamic-components
              type: step.delegate
              config:
                service: admin-component-mgmt
      - method: GET
        path: "/api/v1/admin/components/{id}"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: get-dynamic-component
              type: step.delegate
              config:
                service: admin-component-mgmt
      - method: POST
        path: "/api/v1/admin/components"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: create-dynamic-component
              type: step.delegate
              config:
                service: admin-component-mgmt
      - method: PUT
        path: "/api/v1/admin/components/{id}"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: update-dynamic-component
              type: step.delegate
              config:
                service: admin-component-mgmt
      - method: DELETE
        path: "/api/v1/admin/components/{id}"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: delete-dynamic-component
              type: step.delegate
              config:
                service: admin-component-mgmt

      # ============================================================
      # V1 API: DASHBOARD (Phase D: delegate with meaningful name)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/dashboard"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: get-admin-dashboard
              type: step.delegate
              config:
                service: admin-v1-mgmt

      # ============================================================
      # V1 API: COMPANIES (pipeline-native, handler name updated)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/companies"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-companies
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, name, slug, owner_id, parent_id, is_system, metadata, created_at, updated_at FROM companies WHERE parent_id IS NULL ORDER BY created_at ASC"
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-companies.rows"
      - method: POST
        path: "/api/v1/admin/companies"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                parse_body: true
            - name: validate
              type: step.validate
              config:
                strategy: required_fields
                required_fields: [name]
                source: "steps.parse-request.body"
            - name: prepare
              type: step.set
              config:
                values:
                  id: "{{ uuidv4 }}"
                  now: "{{ now }}"
            - name: insert
              type: step.db_exec
              config:
                database: admin-db
                query: "INSERT INTO companies (id, name, slug, owner_id, parent_id, is_system, metadata, created_at, updated_at) VALUES (?, ?, ?, '', NULL, 0, '{}', ?, ?)"
                params:
                  - "{{ .steps.prepare.id }}"
                  - "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  - "{{lower (index .steps \"parse-request\" \"body\" \"name\")}}"
                  - "{{ .steps.prepare.now }}"
                  - "{{ .steps.prepare.now }}"
            - name: respond
              type: step.json_response
              config:
                status: 201
                body:
                  id: "{{ .steps.prepare.id }}"
                  name: "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  slug: "{{lower (index .steps \"parse-request\" \"body\" \"name\")}}"
                  created_at: "{{ .steps.prepare.now }}"
      - method: GET
        path: "/api/v1/admin/companies/{id}"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: get-company
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, name, slug, owner_id, parent_id, is_system, metadata, created_at, updated_at FROM companies WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: single
            - name: check-found
              type: step.conditional
              config:
                field: "steps.get-company.found"
                routes:
                  "false": not-found
                default: respond
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.get-company.row"
            - name: not-found
              type: step.json_response
              config:
                status: 404
                body:
                  error: "company not found"
      - method: GET
        path: "/api/v1/admin/companies/{id}/organizations"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: list-orgs
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, name, slug, owner_id, parent_id, is_system, metadata, created_at, updated_at FROM companies WHERE parent_id = ? ORDER BY created_at ASC"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-orgs.rows"

      # ============================================================
      # V1 API: ORGANIZATIONS (pipeline-native)
      # ============================================================

      - method: POST
        path: "/api/v1/admin/companies/{id}/organizations"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
                parse_body: true
            - name: validate
              type: step.validate
              config:
                strategy: required_fields
                required_fields: [name]
                source: "steps.parse-request.body"
            - name: prepare
              type: step.set
              config:
                values:
                  id: "{{ uuidv4 }}"
                  now: "{{ now }}"
            - name: insert
              type: step.db_exec
              config:
                database: admin-db
                query: "INSERT INTO companies (id, name, slug, owner_id, parent_id, is_system, metadata, created_at, updated_at) VALUES (?, ?, ?, '', ?, 0, '{}', ?, ?)"
                params:
                  - "{{ .steps.prepare.id }}"
                  - "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  - "{{lower (index .steps \"parse-request\" \"body\" \"name\")}}"
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  - "{{ .steps.prepare.now }}"
                  - "{{ .steps.prepare.now }}"
            - name: respond
              type: step.json_response
              config:
                status: 201
                body:
                  id: "{{ .steps.prepare.id }}"
                  name: "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  slug: "{{lower (index .steps \"parse-request\" \"body\" \"name\")}}"
                  parent_id: "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  created_at: "{{ .steps.prepare.now }}"

      # ============================================================
      # V1 API: PROJECTS (Phase B: POST decomposed into pipeline)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/organizations/{id}/projects"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: list-projects
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, company_id, name, slug, description, is_system, metadata, created_at, updated_at FROM projects WHERE company_id = ? ORDER BY created_at ASC"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-projects.rows"
      - method: POST
        path: "/api/v1/admin/organizations/{id}/projects"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
                parse_body: true
            - name: validate
              type: step.validate
              config:
                strategy: required_fields
                required_fields: [name]
                source: "steps.parse-request.body"
            - name: prepare
              type: step.set
              config:
                values:
                  id: "{{ uuidv4 }}"
                  now: "{{ now }}"
            - name: insert-project
              type: step.db_exec
              config:
                database: admin-db
                query: "INSERT INTO projects (id, company_id, name, slug, description, is_system, metadata, created_at, updated_at) VALUES (?, ?, ?, ?, ?, 0, '{}', ?, ?)"
                params:
                  - "{{ .steps.prepare.id }}"
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  - "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  - "{{lower (index .steps \"parse-request\" \"body\" \"name\")}}"
                  - "{{default \"\" (index .steps \"parse-request\" \"body\" \"description\")}}"
                  - "{{ .steps.prepare.now }}"
                  - "{{ .steps.prepare.now }}"
            - name: respond
              type: step.json_response
              config:
                status: 201
                body:
                  id: "{{ .steps.prepare.id }}"
                  name: "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  slug: "{{lower (index .steps \"parse-request\" \"body\" \"name\")}}"
                  company_id: "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  created_at: "{{ .steps.prepare.now }}"

      # V1 API: PROJECTS (flat listing — all projects across all orgs)
      - method: GET
        path: "/api/v1/admin/projects"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-all-projects
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, company_id, name, slug, description, is_system, metadata, created_at, updated_at FROM projects ORDER BY created_at ASC"
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-all-projects.rows"

      # ============================================================
      # V1 API: WORKFLOWS (Phase B: POST/PUT/deploy/stop decomposed)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/projects/{id}/workflows"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: list-workflows
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, project_id, name, slug, description, config_yaml, version, status, is_system, workspace_dir, created_by, updated_by, created_at, updated_at FROM workflows WHERE project_id = ? ORDER BY created_at DESC"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-workflows.rows"
      - method: POST
        path: "/api/v1/admin/projects/{id}/workflows"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
                parse_body: true
            - name: validate
              type: step.validate
              config:
                strategy: required_fields
                required_fields: [name]
                source: "steps.parse-request.body"
            - name: prepare
              type: step.set
              config:
                values:
                  id: "{{ uuidv4 }}"
                  now: "{{ now }}"
            - name: insert-workflow
              type: step.db_exec
              config:
                database: admin-db
                query: "INSERT INTO workflows (id, project_id, name, slug, description, config_yaml, version, status, is_system, created_by, updated_by, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, 1, 'draft', 0, '', '', ?, ?)"
                params:
                  - "{{ .steps.prepare.id }}"
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  - "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  - "{{lower (index .steps \"parse-request\" \"body\" \"name\")}}"
                  - "{{default \"\" (index .steps \"parse-request\" \"body\" \"description\")}}"
                  - "{{default \"\" (index .steps \"parse-request\" \"body\" \"config_yaml\")}}"
                  - "{{ .steps.prepare.now }}"
                  - "{{ .steps.prepare.now }}"
            - name: respond
              type: step.json_response
              config:
                status: 201
                body:
                  id: "{{ .steps.prepare.id }}"
                  name: "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  slug: "{{lower (index .steps \"parse-request\" \"body\" \"name\")}}"
                  project_id: "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  status: "draft"
                  version: 1
                  created_at: "{{ .steps.prepare.now }}"

      - method: GET
        path: "/api/v1/admin/workflows"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-all-workflows
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, project_id, name, slug, description, config_yaml, version, status, is_system, workspace_dir, created_by, updated_by, created_at, updated_at FROM workflows ORDER BY created_at DESC"
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-all-workflows.rows"
      - method: POST
        path: "/api/v1/admin/workflows"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                parse_body: true
            - name: validate
              type: step.validate
              config:
                strategy: required_fields
                required_fields: [name, project_id]
                source: "steps.parse-request.body"
            - name: prepare
              type: step.set
              config:
                values:
                  id: "{{ uuidv4 }}"
                  now: "{{ now }}"
            - name: insert-workflow
              type: step.db_exec
              config:
                database: admin-db
                query: "INSERT INTO workflows (id, project_id, name, slug, description, config_yaml, version, status, is_system, created_by, updated_by, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, 1, 'draft', 0, '', '', ?, ?)"
                params:
                  - "{{ .steps.prepare.id }}"
                  - "{{index .steps \"parse-request\" \"body\" \"project_id\"}}"
                  - "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  - "{{lower (index .steps \"parse-request\" \"body\" \"name\")}}"
                  - "{{default \"\" (index .steps \"parse-request\" \"body\" \"description\")}}"
                  - "{{default \"\" (index .steps \"parse-request\" \"body\" \"config_yaml\")}}"
                  - "{{ .steps.prepare.now }}"
                  - "{{ .steps.prepare.now }}"
            - name: respond
              type: step.json_response
              config:
                status: 201
                body:
                  id: "{{ .steps.prepare.id }}"
                  name: "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  project_id: "{{index .steps \"parse-request\" \"body\" \"project_id\"}}"
                  status: "draft"
                  version: 1
                  created_at: "{{ .steps.prepare.now }}"
      - method: GET
        path: "/api/v1/admin/workflows/{id}"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: get-workflow
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, project_id, name, slug, description, config_yaml, version, status, is_system, workspace_dir, created_by, updated_by, created_at, updated_at FROM workflows WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: single
            - name: check-found
              type: step.conditional
              config:
                field: "steps.get-workflow.found"
                routes:
                  "false": not-found
                default: respond
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.get-workflow.row"
            - name: not-found
              type: step.json_response
              config:
                status: 404
                body:
                  error: "workflow not found"
      - method: PUT
        path: "/api/v1/admin/workflows/{id}"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
                parse_body: true
            - name: check-exists
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, version, is_system FROM workflows WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: single
            - name: check-found
              type: step.conditional
              config:
                field: "steps.check-exists.found"
                routes:
                  "false": not-found
                default: prepare-update
            - name: prepare-update
              type: step.set
              config:
                values:
                  now: "{{ now }}"
                  version_id: "{{ uuidv4 }}"
            - name: update-workflow
              type: step.db_exec
              config:
                database: admin-db
                query: >-
                  UPDATE workflows SET
                    name = COALESCE(NULLIF(?, ''), name),
                    slug = COALESCE(NULLIF(?, ''), slug),
                    description = COALESCE(NULLIF(?, ''), description),
                    config_yaml = COALESCE(NULLIF(?, ''), config_yaml),
                    version = CASE WHEN NULLIF(?, '') IS NOT NULL AND NULLIF(?, '') != config_yaml THEN version + 1 ELSE version END,
                    updated_by = ?,
                    updated_at = ?
                  WHERE id = ?
                params:
                  - "{{default \"\" (index .steps \"parse-request\" \"body\" \"name\")}}"
                  - "{{default \"\" (index .steps \"parse-request\" \"body\" \"name\")}}"
                  - "{{default \"\" (index .steps \"parse-request\" \"body\" \"description\")}}"
                  - "{{default \"\" (index .steps \"parse-request\" \"body\" \"config_yaml\")}}"
                  - "{{default \"\" (index .steps \"parse-request\" \"body\" \"config_yaml\")}}"
                  - "{{default \"\" (index .steps \"parse-request\" \"body\" \"config_yaml\")}}"
                  - ""
                  - "{{index .steps \"prepare-update\" \"now\"}}"
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
            - name: save-version
              type: step.db_exec
              config:
                database: admin-db
                query: "INSERT INTO workflow_versions (id, workflow_id, version, config_yaml, created_by, created_at) SELECT ?, id, version, config_yaml, '', ? FROM workflows WHERE id = ?"
                params:
                  - "{{index .steps \"prepare-update\" \"version_id\"}}"
                  - "{{index .steps \"prepare-update\" \"now\"}}"
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
            - name: get-updated
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, project_id, name, slug, description, config_yaml, version, status, is_system, workspace_dir, created_by, updated_by, created_at, updated_at FROM workflows WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: single
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.get-updated.row"
            - name: not-found
              type: step.json_response
              config:
                status: 404
                body:
                  error: "workflow not found"
      - method: DELETE
        path: "/api/v1/admin/workflows/{id}"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: check-exists
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, is_system FROM workflows WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: single
            - name: check-found
              type: step.conditional
              config:
                field: "steps.check-exists.found"
                routes:
                  "false": not-found
                default: delete
            - name: delete
              type: step.db_exec
              config:
                database: admin-db
                query: "DELETE FROM workflows WHERE id = ? AND is_system = 0"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  deleted: true
                  id: "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
            - name: not-found
              type: step.json_response
              config:
                status: 404
                body:
                  error: "workflow not found"
      - method: GET
        path: "/api/v1/admin/workflows/{id}/versions"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: get-versions
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, workflow_id, version, config_yaml, created_at, created_by FROM workflow_versions WHERE workflow_id = ? ORDER BY version DESC"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.get-versions.rows"
      # Deploy: update status to 'active', return the updated workflow record
      - method: POST
        path: "/api/v1/admin/workflows/{id}/deploy"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: set-target-status
              type: step.set
              config:
                values:
                  target_status: "active"
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: check-exists
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id FROM workflows WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: single
            - name: check-found
              type: step.conditional
              config:
                field: "steps.check-exists.found"
                routes:
                  "false": not-found
                default: set-now
            - name: set-now
              type: step.set
              config:
                values:
                  now: "{{ now }}"
            - name: update-status
              type: step.db_exec
              config:
                database: admin-db
                query: "UPDATE workflows SET status = ?, updated_at = ? WHERE id = ?"
                params:
                  - "{{index .steps \"set-target-status\" \"target_status\"}}"
                  - "{{index .steps \"set-now\" \"now\"}}"
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
            - name: get-updated
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, project_id, name, slug, description, config_yaml, version, status, is_system, workspace_dir, created_by, updated_by, created_at, updated_at FROM workflows WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: single
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.get-updated.row"
            - name: not-found
              type: step.json_response
              config:
                status: 404
                body:
                  error: "workflow not found"
      # Stop: update status to 'stopped', return the updated workflow record
      - method: POST
        path: "/api/v1/admin/workflows/{id}/stop"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: set-target-status
              type: step.set
              config:
                values:
                  target_status: "stopped"
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: check-exists
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id FROM workflows WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: single
            - name: check-found
              type: step.conditional
              config:
                field: "steps.check-exists.found"
                routes:
                  "false": not-found
                default: set-now
            - name: set-now
              type: step.set
              config:
                values:
                  now: "{{ now }}"
            - name: update-status
              type: step.db_exec
              config:
                database: admin-db
                query: "UPDATE workflows SET status = ?, updated_at = ? WHERE id = ?"
                params:
                  - "{{index .steps \"set-target-status\" \"target_status\"}}"
                  - "{{index .steps \"set-now\" \"now\"}}"
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
            - name: get-updated
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, project_id, name, slug, description, config_yaml, version, status, is_system, workspace_dir, created_by, updated_by, created_at, updated_at FROM workflows WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: single
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.get-updated.row"
            - name: not-found
              type: step.json_response
              config:
                status: 404
                body:
                  error: "workflow not found"
      # Load workflow from a server-local filesystem path
      - method: POST
        path: "/api/v1/admin/workflows/load-from-path"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: load-from-path
              type: step.delegate
              config:
                service: admin-v1-mgmt
      # Import/Export workflow bundles
      - method: POST
        path: "/api/v1/admin/workflows/import"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: import-workflow-bundle
              type: step.delegate
              config:
                service: admin-v1-mgmt
      - method: GET
        path: "/api/v1/admin/workflows/{id}/export"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: export-workflow-bundle
              type: step.delegate
              config:
                service: admin-v1-mgmt
      - method: GET
        path: "/api/v1/admin/workflows/{id}/status"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: get-status
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, name, status, version, updated_at FROM workflows WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: single
            - name: check-found
              type: step.conditional
              config:
                field: "steps.get-status.found"
                routes:
                  "false": not-found
                default: respond
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.get-status.row"
            - name: not-found
              type: step.json_response
              config:
                status: 404
                body:
                  error: "workflow not found"
      - method: GET
        path: "/api/v1/admin/workflows/{id}/dashboard"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: get-workflow
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, project_id, name, slug, description, config_yaml, version, status, is_system, workspace_dir, created_by, updated_by, created_at, updated_at FROM workflows WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: single
            - name: get-execution-stats
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT COUNT(*) as total, SUM(CASE WHEN status='completed' THEN 1 ELSE 0 END) as completed, SUM(CASE WHEN status='failed' THEN 1 ELSE 0 END) as failed, SUM(CASE WHEN status='running' THEN 1 ELSE 0 END) as running FROM workflow_executions WHERE workflow_id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: single
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  workflow: "{{index .steps \"get-workflow\" \"row\"}}"
                  stats: "{{index .steps \"get-execution-stats\" \"row\"}}"

      # ============================================================
      # V1 API: EXECUTIONS (Phase C: decomposed with new tables)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/workflows/{id}/executions"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: list-executions
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, workflow_id, trigger_type, status, started_at, completed_at, duration_ms, error_message FROM workflow_executions WHERE workflow_id = ? ORDER BY started_at DESC LIMIT 100"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-executions.rows"
      - method: POST
        path: "/api/v1/admin/workflows/{id}/trigger"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
                parse_body: true
            - name: prepare
              type: step.set
              config:
                values:
                  id: "{{ uuidv4 }}"
                  now: "{{ now }}"
            - name: insert-execution
              type: step.db_exec
              config:
                database: admin-db
                query: "INSERT INTO workflow_executions (id, workflow_id, trigger_type, trigger_data, status, started_at, metadata) VALUES (?, ?, 'manual', ?, 'pending', ?, '{}')"
                params:
                  - "{{ .steps.prepare.id }}"
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  - "{{default \"{}\" (index .steps \"parse-request\" \"body\")}}"
                  - "{{ .steps.prepare.now }}"
            - name: complete-execution
              type: step.db_exec
              config:
                database: admin-db
                query: "UPDATE workflow_executions SET status='completed', completed_at=?, duration_ms=0 WHERE id=?"
                params:
                  - "{{ .steps.prepare.now }}"
                  - "{{ .steps.prepare.id }}"
            - name: respond
              type: step.json_response
              config:
                status: 202
                body:
                  id: "{{ .steps.prepare.id }}"
                  workflow_id: "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  status: "pending"
                  started_at: "{{ .steps.prepare.now }}"
      - method: GET
        path: "/api/v1/admin/executions/{id}"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: validate-id
              type: step.validate_path_param
              config:
                params: [id]
                format: uuid
                source: "steps.parse-request.path_params"
            - name: get-execution
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, workflow_id, trigger_type, trigger_data, status, output_data, error_message, started_at, completed_at, duration_ms, metadata FROM workflow_executions WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: single
            - name: check-found
              type: step.conditional
              config:
                field: "steps.get-execution.found"
                routes:
                  "false": not-found
                default: respond
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.get-execution.row"
            - name: not-found
              type: step.json_response
              config:
                status: 404
                body:
                  error: "execution not found"
      - method: GET
        path: "/api/v1/admin/executions/{id}/steps"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: validate-id
              type: step.validate_path_param
              config:
                params: [id]
                format: uuid
                source: "steps.parse-request.path_params"
            - name: validate-pagination
              type: step.validate_pagination
              config:
                max_limit: 100
                default_limit: 50
                default_page: 1
            - name: list-steps
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, execution_id, step_name, step_type, status, error_message, started_at, completed_at, duration_ms, sequence_num FROM execution_steps WHERE execution_id = ? ORDER BY sequence_num ASC"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-steps.rows"
      - method: POST
        path: "/api/v1/admin/executions/{id}/cancel"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: set-now
              type: step.set
              config:
                values:
                  now: "{{ now }}"
            - name: cancel-execution
              type: step.db_exec
              config:
                database: admin-db
                query: "UPDATE workflow_executions SET status='cancelled', completed_at=? WHERE id=? AND status IN ('pending','running')"
                params:
                  - "{{index .steps \"set-now\" \"now\"}}"
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  id: "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  status: "cancelled"

      # ============================================================
      # V1 API: LOGS & EVENTS (Phase C: logs decomposed, streams delegated)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/workflows/{id}/logs"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: list-logs
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, workflow_id, execution_id, level, message, module_name, fields, created_at FROM execution_logs WHERE workflow_id = ? ORDER BY created_at DESC LIMIT 100"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-logs.rows"
      - method: GET
        path: "/api/v1/admin/workflows/{id}/logs/stream"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: stream-workflow-logs
              type: step.delegate
              config:
                service: admin-v1-mgmt
      - method: GET
        path: "/api/v1/admin/workflows/{id}/events"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: list-events
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, workflow_id, execution_id, level, message, module_name, fields, created_at FROM execution_logs WHERE workflow_id = ? AND level = 'event' ORDER BY created_at DESC LIMIT 100"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-events.rows"
      - method: GET
        path: "/api/v1/admin/workflows/{id}/events/stream"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: stream-workflow-events
              type: step.delegate
              config:
                service: admin-v1-mgmt

      # ============================================================
      # V1 API: PERMISSIONS (Phase C: stub until memberships wired)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/workflows/{id}/permissions"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: respond
              type: step.json_response
              config:
                status: 200
                body: []
      - method: POST
        path: "/api/v1/admin/workflows/{id}/permissions"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: respond
              type: step.json_response
              config:
                status: 501
                body:
                  error: "permission management not yet implemented"

      # ============================================================
      # V1 API: AUDIT (Phase C: decomposed with new table)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/audit"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-audit
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, user_id, action, resource_type, resource_id, details, ip_address, created_at FROM audit_log ORDER BY created_at DESC LIMIT 100"
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-audit.rows"

      # ============================================================
      # V1 API: IAM (Phase C: decomposed with new tables)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/iam/providers"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-iam-providers
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, name, type, client_id, enabled, created_at, updated_at FROM iam_provider_configs ORDER BY created_at DESC"
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-iam-providers.rows"

      - method: GET
        path: "/api/v1/admin/iam/providers/{id}"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: get-provider
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, company_id, provider_type, name, config, enabled, created_at, updated_at FROM iam_provider_configs WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: single
            - name: check-found
              type: step.conditional
              config:
                field: "steps.get-provider.found"
                routes:
                  "false": not-found
                default: respond
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.get-provider.row"
            - name: not-found
              type: step.json_response
              config:
                status: 404
                body:
                  error: "IAM provider not found"
      - method: POST
        path: "/api/v1/admin/iam/providers"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                parse_body: true
            - name: validate
              type: step.validate
              config:
                strategy: required_fields
                required_fields: [name, provider_type, company_id]
                source: "steps.parse-request.body"
            - name: prepare
              type: step.set
              config:
                values:
                  id: "{{ uuidv4 }}"
                  now: "{{ now }}"
            - name: insert-provider
              type: step.db_exec
              config:
                database: admin-db
                query: "INSERT INTO iam_provider_configs (id, company_id, provider_type, name, config, enabled, created_at, updated_at) VALUES (?, ?, ?, ?, ?, 1, ?, ?)"
                params:
                  - "{{ .steps.prepare.id }}"
                  - "{{index .steps \"parse-request\" \"body\" \"company_id\"}}"
                  - "{{index .steps \"parse-request\" \"body\" \"provider_type\"}}"
                  - "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  - "{{default \"{}\" (index .steps \"parse-request\" \"body\" \"config\")}}"
                  - "{{ .steps.prepare.now }}"
                  - "{{ .steps.prepare.now }}"
            - name: respond
              type: step.json_response
              config:
                status: 201
                body:
                  id: "{{ .steps.prepare.id }}"
                  name: "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  provider_type: "{{index .steps \"parse-request\" \"body\" \"provider_type\"}}"
                  enabled: true
                  created_at: "{{ .steps.prepare.now }}"
      - method: PUT
        path: "/api/v1/admin/iam/providers/{id}"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
                parse_body: true
            - name: set-now
              type: step.set
              config:
                values:
                  now: "{{ now }}"
            - name: update-provider
              type: step.db_exec
              config:
                database: admin-db
                query: "UPDATE iam_provider_configs SET name=?, config=?, enabled=?, updated_at=? WHERE id=?"
                params:
                  - "{{index .steps \"parse-request\" \"body\" \"name\"}}"
                  - "{{default \"{}\" (index .steps \"parse-request\" \"body\" \"config\")}}"
                  - "{{default \"1\" (index .steps \"parse-request\" \"body\" \"enabled\")}}"
                  - "{{index .steps \"set-now\" \"now\"}}"
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  id: "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  updated_at: "{{index .steps \"set-now\" \"now\"}}"
      - method: DELETE
        path: "/api/v1/admin/iam/providers/{id}"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: delete-provider
              type: step.db_exec
              config:
                database: admin-db
                query: "DELETE FROM iam_provider_configs WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  deleted: true
                  id: "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
      - method: POST
        path: "/api/v1/admin/iam/providers/{id}/test"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  status: "ok"
                  message: "connection test not yet implemented"
      - method: GET
        path: "/api/v1/admin/iam/providers/{id}/mappings"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: list-mappings
              type: step.db_query
              config:
                database: admin-db
                query: "SELECT id, provider_id, external_identifier, resource_type, resource_id, role, created_at FROM iam_role_mappings WHERE provider_id = ? ORDER BY created_at DESC"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
                mode: list
            - name: respond
              type: step.json_response
              config:
                status: 200
                body_from: "steps.list-mappings.rows"
      - method: POST
        path: "/api/v1/admin/iam/providers/{id}/mappings"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
                parse_body: true
            - name: validate
              type: step.validate
              config:
                strategy: required_fields
                required_fields: [external_identifier, resource_type, resource_id, role]
                source: "steps.parse-request.body"
            - name: prepare
              type: step.set
              config:
                values:
                  id: "{{ uuidv4 }}"
                  now: "{{ now }}"
            - name: insert-mapping
              type: step.db_exec
              config:
                database: admin-db
                query: "INSERT INTO iam_role_mappings (id, provider_id, external_identifier, resource_type, resource_id, role, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)"
                params:
                  - "{{ .steps.prepare.id }}"
                  - "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  - "{{index .steps \"parse-request\" \"body\" \"external_identifier\"}}"
                  - "{{index .steps \"parse-request\" \"body\" \"resource_type\"}}"
                  - "{{index .steps \"parse-request\" \"body\" \"resource_id\"}}"
                  - "{{index .steps \"parse-request\" \"body\" \"role\"}}"
                  - "{{ .steps.prepare.now }}"
            - name: respond
              type: step.json_response
              config:
                status: 201
                body:
                  id: "{{ .steps.prepare.id }}"
                  provider_id: "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"
                  role: "{{index .steps \"parse-request\" \"body\" \"role\"}}"
                  created_at: "{{ .steps.prepare.now }}"
      - method: DELETE
        path: "/api/v1/admin/iam/mappings/{id}"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: delete-mapping
              type: step.db_exec
              config:
                database: admin-db
                query: "DELETE FROM iam_role_mappings WHERE id = ?"
                params: ["{{index .steps \"parse-request\" \"path_params\" \"id\"}}"]
            - name: respond
              type: step.json_response
              config:
                status: 200
                body:
                  deleted: true
                  id: "{{index .steps \"parse-request\" \"path_params\" \"id\"}}"

      # ============================================================
      # TIMELINE / REPLAY API (Phase D: delegates with meaningful names)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/executions"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: validate-pagination
              type: step.validate_pagination
              config:
                max_limit: 100
                default_limit: 20
                default_page: 1
            - name: list-all-executions
              type: step.delegate
              config:
                service: admin-timeline-mgmt
      - method: GET
        path: "/api/v1/admin/executions/{id}/timeline"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: get-execution-timeline
              type: step.delegate
              config:
                service: admin-timeline-mgmt
      - method: GET
        path: "/api/v1/admin/executions/{id}/events"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: get-execution-events
              type: step.delegate
              config:
                service: admin-timeline-mgmt
      - method: POST
        path: "/api/v1/admin/executions/{id}/replay"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: replay-execution
              type: step.delegate
              config:
                service: admin-replay-mgmt
      - method: GET
        path: "/api/v1/admin/executions/{id}/replay"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: get-replay-history
              type: step.delegate
              config:
                service: admin-replay-mgmt

      # ============================================================
      # DLQ API (Phase D: delegates with meaningful names)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/dlq"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-dlq-entries
              type: step.delegate
              config:
                service: admin-dlq-mgmt
      - method: GET
        path: "/api/v1/admin/dlq/stats"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: get-dlq-stats
              type: step.delegate
              config:
                service: admin-dlq-mgmt
      - method: GET
        path: "/api/v1/admin/dlq/{id}"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: get-dlq-entry
              type: step.delegate
              config:
                service: admin-dlq-mgmt
      - method: POST
        path: "/api/v1/admin/dlq/{id}/retry"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: validate-id
              type: step.validate_path_param
              config:
                params: [id]
                format: uuid
                source: "steps.parse-request.path_params"
            - name: rate-limit
              type: step.rate_limit
              config:
                requests_per_minute: 30
                burst_size: 5
                key_from: "global"
            - name: retry-dlq-entry
              type: step.delegate
              config:
                service: admin-dlq-mgmt
      - method: POST
        path: "/api/v1/admin/dlq/{id}/discard"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: parse-request
              type: step.request_parse
              config:
                path_params: [id]
            - name: validate-id
              type: step.validate_path_param
              config:
                params: [id]
                format: uuid
                source: "steps.parse-request.path_params"
            - name: rate-limit
              type: step.rate_limit
              config:
                requests_per_minute: 30
                burst_size: 5
                key_from: "global"
            - name: discard-dlq-entry
              type: step.delegate
              config:
                service: admin-dlq-mgmt
      - method: POST
        path: "/api/v1/admin/dlq/{id}/resolve"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: resolve-dlq-entry
              type: step.delegate
              config:
                service: admin-dlq-mgmt
      - method: DELETE
        path: "/api/v1/admin/dlq/purge"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: purge-resolved-dlq
              type: step.delegate
              config:
                service: admin-dlq-mgmt

      # ============================================================
      # BACKFILL / MOCK / DIFF API (Phase D: delegates with meaningful names)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/backfill"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-backfills
              type: step.delegate
              config:
                service: admin-backfill-mgmt
      - method: POST
        path: "/api/v1/admin/backfill"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: create-backfill
              type: step.delegate
              config:
                service: admin-backfill-mgmt
      - method: GET
        path: "/api/v1/admin/backfill/{id}"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: get-backfill
              type: step.delegate
              config:
                service: admin-backfill-mgmt
      - method: POST
        path: "/api/v1/admin/backfill/{id}/cancel"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: cancel-backfill
              type: step.delegate
              config:
                service: admin-backfill-mgmt
      - method: GET
        path: "/api/v1/admin/mocks"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-mocks
              type: step.delegate
              config:
                service: admin-backfill-mgmt
      - method: POST
        path: "/api/v1/admin/mocks"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: set-step-mock
              type: step.delegate
              config:
                service: admin-backfill-mgmt
      - method: DELETE
        path: "/api/v1/admin/mocks"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: clear-all-mocks
              type: step.delegate
              config:
                service: admin-backfill-mgmt
      - method: GET
        path: "/api/v1/admin/mocks/{pipeline}"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-pipeline-mocks
              type: step.delegate
              config:
                service: admin-backfill-mgmt
      - method: DELETE
        path: "/api/v1/admin/mocks/{pipeline}/{step}"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: remove-step-mock
              type: step.delegate
              config:
                service: admin-backfill-mgmt
      - method: GET
        path: "/api/v1/admin/executions/diff"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: compute-execution-diff
              type: step.delegate
              config:
                service: admin-backfill-mgmt

      # ============================================================
      # BILLING API (Phase D: delegates with meaningful names)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/billing/plans"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-billing-plans
              type: step.delegate
              config:
                service: admin-billing-mgmt
      - method: GET
        path: "/api/v1/admin/billing/usage"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: get-usage-report
              type: step.delegate
              config:
                service: admin-billing-mgmt
      - method: POST
        path: "/api/v1/admin/billing/subscribe"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: create-subscription
              type: step.delegate
              config:
                service: admin-billing-mgmt
      - method: DELETE
        path: "/api/v1/admin/billing/subscribe"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: cancel-subscription
              type: step.delegate
              config:
                service: admin-billing-mgmt
      - method: POST
        path: "/api/v1/admin/billing/webhook"
        handler: admin-commands
        middlewares: [admin-cors]
        pipeline:
          steps:
            - name: handle-billing-webhook
              type: step.delegate
              config:
                service: admin-billing-mgmt

      # ============================================================
      # NATIVE PLUGINS (Phase D: delegates with meaningful names)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/plugins"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-native-plugins
              type: step.delegate
              config:
                service: admin-native-plugins
      - method: GET
        path: "/api/v1/admin/plugins/{name}/{path...}"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: plugin-query
              type: step.delegate
              config:
                service: admin-native-plugins
      - method: POST
        path: "/api/v1/admin/plugins/{name}/{path...}"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: plugin-command
              type: step.delegate
              config:
                service: admin-native-plugins
      - method: PUT
        path: "/api/v1/admin/plugins/{name}/{path...}"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: plugin-update
              type: step.delegate
              config:
                service: admin-native-plugins
      - method: DELETE
        path: "/api/v1/admin/plugins/{name}/{path...}"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: plugin-delete
              type: step.delegate
              config:
                service: admin-native-plugins

      # ============================================================
      # ENVIRONMENTS (CI/CD Platform)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/environments"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-environments
              type: step.delegate
              config:
                service: admin-env-mgmt
      - method: POST
        path: "/api/v1/admin/environments"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: create-environment
              type: step.delegate
              config:
                service: admin-env-mgmt
      - method: GET
        path: "/api/v1/admin/environments/{id}"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: get-environment
              type: step.delegate
              config:
                service: admin-env-mgmt
      - method: PUT
        path: "/api/v1/admin/environments/{id}"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: update-environment
              type: step.delegate
              config:
                service: admin-env-mgmt
      - method: DELETE
        path: "/api/v1/admin/environments/{id}"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: delete-environment
              type: step.delegate
              config:
                service: admin-env-mgmt
      - method: POST
        path: "/api/v1/admin/environments/{id}/test"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: test-environment-connection
              type: step.delegate
              config:
                service: admin-env-mgmt

      # ============================================================
      # FEATURE FLAGS
      # ============================================================

      - method: GET
        path: "/api/v1/admin/feature-flags"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-feature-flags
              type: step.delegate
              config:
                service: admin-v1-mgmt
      - method: POST
        path: "/api/v1/admin/feature-flags"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: create-feature-flag
              type: step.delegate
              config:
                service: admin-v1-mgmt
      - method: PUT
        path: "/api/v1/admin/feature-flags/{key}"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: update-feature-flag
              type: step.delegate
              config:
                service: admin-v1-mgmt
      - method: DELETE
        path: "/api/v1/admin/feature-flags/{key}"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: delete-feature-flag
              type: step.delegate
              config:
                service: admin-v1-mgmt
      - method: PUT
        path: "/api/v1/admin/feature-flags/{key}/overrides"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: set-feature-flag-overrides
              type: step.delegate
              config:
                service: admin-v1-mgmt
      - method: GET
        path: "/api/v1/admin/feature-flags/stream"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: stream-feature-flags
              type: step.delegate
              config:
                service: admin-v1-mgmt

      # ============================================================
      # CLOUD PROVIDERS (CI/CD Platform)
      # ============================================================

      - method: GET
        path: "/api/v1/providers/{provider}/status"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: provider-status
              type: step.delegate
              config:
                service: admin-cloud-providers
      - method: GET
        path: "/api/v1/providers/{provider}/regions"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: provider-regions
              type: step.delegate
              config:
                service: admin-cloud-providers

      # ============================================================
      # PLUGIN REGISTRY (CI/CD Platform — remote install/search)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/plugins/registry/search"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: search-plugin-registry
              type: step.delegate
              config:
                service: admin-plugin-registry
      - method: POST
        path: "/api/v1/admin/plugins/registry/install"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: install-plugin
              type: step.delegate
              config:
                service: admin-plugin-registry

      # ============================================================
      # OBSERVABILITY INGEST (unauthenticated — used by remote workers)
      # ============================================================

      - method: POST
        path: "/api/v1/admin/ingest/executions"
        handler: admin-commands
        middlewares: [admin-cors]
        pipeline:
          steps:
            - name: ingest-executions
              type: step.delegate
              config:
                service: admin-ingest-mgmt
      - method: POST
        path: "/api/v1/admin/ingest/logs"
        handler: admin-commands
        middlewares: [admin-cors]
        pipeline:
          steps:
            - name: ingest-logs
              type: step.delegate
              config:
                service: admin-ingest-mgmt
      - method: POST
        path: "/api/v1/admin/ingest/events"
        handler: admin-commands
        middlewares: [admin-cors]
        pipeline:
          steps:
            - name: ingest-events
              type: step.delegate
              config:
                service: admin-ingest-mgmt
      - method: GET
        path: "/api/v1/admin/ingest/health"
        handler: admin-queries
        middlewares: [admin-cors]
        pipeline:
          steps:
            - name: ingest-health
              type: step.delegate
              config:
                service: admin-ingest-mgmt
      - method: POST
        path: "/api/v1/admin/instances/register"
        handler: admin-commands
        middlewares: [admin-cors]
        pipeline:
          steps:
            - name: instance-register
              type: step.delegate
              config:
                service: admin-ingest-mgmt
      - method: POST
        path: "/api/v1/admin/instances/heartbeat"
        handler: admin-commands
        middlewares: [admin-cors]
        pipeline:
          steps:
            - name: instance-heartbeat
              type: step.delegate
              config:
                service: admin-ingest-mgmt

      # ============================================================
      # RUNTIME INSTANCES (authenticated — manage loaded workflows)
      # ============================================================

      - method: GET
        path: "/api/v1/admin/runtime/instances"
        handler: admin-queries
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: list-runtime-instances
              type: step.delegate
              config:
                service: admin-runtime-mgmt
      - method: POST
        path: "/api/v1/admin/runtime/instances/{id}/stop"
        handler: admin-commands
        middlewares: [admin-cors, admin-auth-middleware]
        pipeline:
          steps:
            - name: stop-runtime-instance
              type: step.delegate
              config:
                service: admin-runtime-mgmt

      # ============================================================
      # OPENAPI SPEC (unauthenticated, read-only)
      # ============================================================

      - method: GET
        path: "/api/openapi.json"
        handler: admin-openapi
        middlewares: [admin-cors]
      - method: GET
        path: "/api/openapi.yaml"
        handler: admin-openapi
        middlewares: [admin-cors]
